# ASA 麻醉風險分級預測 - 改善歷程總結

## 專案概述
- **目標**: 預測 ASA (American Society of Anesthesiologists) 麻醉風險分級 (1-4級)
- **資料集**: Kaggle 競賽資料
  - 訓練集: 14,734 筆
  - 測試集: 6,315 筆
- **評估指標**: F1 Macro Score

---

## 一、資料清洗階段

### 1.1 原始資料概覽
- **訓練集**: 14,734 筆 × 25 欄位
- **測試集**: 6,315 筆 × 24 欄位（無 ASA_Rating）

### 1.2 逐欄位檢查與清洗

#### Gender（性別）
- **檢查結果**: Male 53.6%, Female 46.4%, 無缺失
- **問題**: 無
- **處理**: 無需處理

#### ICU_Patient（是否為 ICU 患者）
- **檢查結果**: No 94.3%, Yes 5.7%, 無缺失
- **問題**: 無
- **處理**: 無需處理

#### Age（年齡）
- **檢查結果**: 範圍 17-90+, 無缺失
- **問題**: 無異常值
- **處理**: 無需處理
- **後續衍生**: `age_group`, `is_elderly`

#### HEIGHT（身高）⚠️ 重點欄位
- **檢查結果**: 缺失 3,893 筆 (26.4%), 最小值 88.9cm (異常)
- **問題 1 - 高缺失率**:
  - 分析過程：交叉比對 Patient_Source、ICU_Patient、ASA_Rating
  - 發現：門診來源、非 ICU、ASA 1-2 缺失率較高
  - 結論：**MNAR (Missing Not At Random)**，低風險患者術前評估較簡化
- **問題 2 - 異常值 88.9cm**: 成人不可能，判定為輸入錯誤
- **處理**:
  ```python
  # 異常值轉 NaN
  train_df.loc[train_df['HEIGHT'] < 100, 'HEIGHT'] = np.nan
  # 用性別+年齡組中位數填補
  train_df['HEIGHT'] = train_df.groupby(['Gender', 'age_group'])['HEIGHT'].transform(
      lambda x: x.fillna(x.median()))
  ```

#### WEIGHT（體重）⚠️ 重點欄位
- **檢查結果**: WEIGHT=0 有 507 筆, 空值 727 筆
- **問題**: 體重為 0 明顯為資料缺失或輸入錯誤
- **處理**:
  ```python
  # 0 轉 NaN
  train_df.loc[train_df['WEIGHT'] == 0, 'WEIGHT'] = np.nan
  # 用性別+年齡組中位數填補
  train_df['WEIGHT'] = train_df.groupby(['Gender', 'age_group'])['WEIGHT'].transform(
      lambda x: x.fillna(x.median()))
  ```

#### BMI（身體質量指數）⚠️ 新增欄位
- **問題**: 原始資料沒有 BMI 欄位
- **重要性**: 文獻指出 BMI 是 ASA 分級的明確標準
- **處理**: 在 HEIGHT/WEIGHT 清洗後計算
  ```python
  train_df['BMI'] = train_df['WEIGHT'] / ((train_df['HEIGHT'] / 100) ** 2)
  ```

#### Anesthesia_Method（麻醉方式）
- **檢查結果**: 發現 'MAC' 和 'MAC ' 被視為不同類別, 缺失 11 筆
- **問題**: 尾部空格導致類別重複
- **處理**:
  ```python
  train_df['Anesthesia_Method'] = train_df['Anesthesia_Method'].str.strip()
  # 缺失值在模型訓練時填為 'Unknown'
  ```

#### Patient_Source（患者來源）
- **檢查結果**: 多種來源類別, 無缺失
- **問題**: 無
- **處理**: 無需處理

#### Surgery_Name（手術名稱）
- **檢查結果**: 自由文字, 格式不統一
- **問題**: 需要標準化和分類
- **處理**: 在 `surgery_classification.py` 中提取
  - `Surgery_Category`: 手術大類
  - `Surgery_Procedure_Type`: 手術類型
  - `Surgery_Count`: 手術數量

#### Surgery_Count（手術數量）
- **檢查結果**: 部分為 0
- **問題**: 既然有手術記錄，不應為 0
- **處理**:
  ```python
  train_df.loc[train_df['Surgery_Count'] == 0, 'Surgery_Count'] = 1
  ```

#### Medication_Usage（用藥紀錄）
- **檢查結果**: 自由文字, 藥物名稱逗號分隔
- **問題**: 需從文字提取結構化資訊
- **處理**: 在 `medication_classification.py` 中提取
  - `Drug_Category`: 藥物類別
  - `Drug_Standardized`: 標準化藥物名稱
  - `Route_Standardized`: 給藥途徑

#### Lab_Values（檢驗值）
- **檢查結果**: 格式「項目: 數值 單位 (狀態)」, 狀態有 N/H/L/HH/LL
- **問題**: 需提取異常指標資訊
- **處理**: 在方法B特徵工程中提取 7 個特徵

#### properties_display（其他屬性）
- **檢查結果**: 包含 IV 導管、護理記錄, 與麻醉設備無關
- **問題**: 連續空格、缺失值標記不統一
- **處理**:
  ```python
  # 移除多餘空格
  train_df['properties_display'] = train_df['properties_display'].str.replace(r'\s+', ' ', regex=True)
  ```
- **結論**: 與 ASA 相關性較低，暫不深入提取

#### Catheter_Use（導管使用）
- **檢查結果**: 導管類型逗號分隔
- **問題**: 連續空格, 類似名稱需合併 (INTRA-OSSEOUS vs INTRAOSSEOUS)
- **處理**:
  ```python
  train_df['Catheter_Use'] = train_df['Catheter_Use'].str.replace(r'\s+', ' ', regex=True)
  train_df['Catheter_Use'] = train_df['Catheter_Use'].str.replace('INTRA-OSSEOUS', 'INTRAOSSEOUS')
  ```

#### ASA_Rating（目標變數）
- **檢查結果**: ASA 1: 5.4%, ASA 2: 34.2%, ASA 3: 51.2%, ASA 4: 9.2%
- **問題**: 類別不平衡 (ASA 3 : ASA 1 = 9.4 : 1)
- **處理**: 模型訓練時使用 `class_weight='balanced'` 或 SMOTE

### 1.3 清洗執行順序
```
1. WEIGHT = 0 → NaN
2. HEIGHT < 100 → NaN
3. 計算 age_group (用於填補)
4. 填補 HEIGHT (性別+年齡組中位數)
5. 填補 WEIGHT (性別+年齡組中位數)
6. 計算 BMI
7. Anesthesia_Method 去除空格
8. Surgery_Count = 0 → 1
9. 文字欄位標準化處理
```

### 1.4 清洗前後比較
| 欄位 | 清洗前問題 | 清洗後狀態 |
|------|-----------|-----------|
| HEIGHT | 26.4% 缺失 + 3筆異常 | 100% 有效 |
| WEIGHT | 0值 + 空值 | 100% 有效 |
| BMI | 不存在 | 新增計算 |
| Anesthesia_Method | 重複類別 | 統一格式 |
| Surgery_Count | 0值 | 最小值=1 |

### 1.5 關鍵發現
- **HEIGHT 缺失分析**: 經交叉比對發現，缺失主要發生在門診來源、非ICU、ASA 1-2 的患者
- **結論**: 缺失為 MNAR (Missing Not At Random)，但對高風險患者影響較小

---

## 二、文獻回顧

### 2.1 搜尋來源
- PubMed
- Cochrane Library

### 2.2 關鍵發現
1. **BMI 在 ASA 分級中的明確標準**:
   - BMI < 30: ASA I
   - BMI 30-35: ASA II
   - BMI ≥ 40: ASA III

2. **重要預測特徵**:
   - 年齡
   - BMI
   - 慢性病用藥（心臟、糖尿病、抗凝血）
   - 檢驗異常值
   - 手術類型

---

## 三、特徵工程階段

### 3.1 方法演進

| 方法 | 特徵數 | 說明 |
|------|--------|------|
| A: Baseline | 13 | 5 數值 + 8 類別（原始特徵） |
| B: 完整特徵 | 40 | 從文字欄位提取 27 個新特徵 |
| C: 交互特徵 | 70 | B + 30 個 PolynomialFeatures 交互項 |

### 3.2 方法B 新增特徵

**Lab 特徵 (7個)**:
- lab_count, lab_abnormal_H, lab_abnormal_L
- lab_critical_HH, lab_critical_LL
- lab_has_data, lab_abnormal_total

**Medication 特徵 (7個)**:
- med_count, has_chronic_med, has_cardiac_med
- has_diabetes_med, has_anticoagulant
- has_opioid, has_sedative

**Catheter 特徵 (8個)**:
- catheter_count, has_catheter, has_piv
- has_urinary, has_cvc, has_arterial
- has_chest_tube, has_wound

**其他衍生特徵 (5個)**:
- age_group, bmi_category
- is_elderly, is_obese, is_morbid_obese

### 3.3 方法C 交互特徵

使用 `PolynomialFeatures(degree=2, interaction_only=True)` 產生二階交互項

**Top 交互特徵**:
1. lab_abnormal_total × lab_count
2. lab_abnormal_total × catheter_count
3. Age × lab_abnormal_total
4. lab_count × lab_critical_HH

---

## 四、模型訓練與優化

### 4.1 模型比較
測試的模型：
- Logistic Regression
- Random Forest
- Gradient Boosting
- XGBoost
- **LightGBM** (最佳)

### 4.2 優化方法

| 方法 | 技術 | Kaggle Score | 本地 F1 |
|------|------|--------------|---------|
| A: Baseline | 13 特徵 + LightGBM | 0.46513 | 0.4517 |
| B: 完整特徵 | 40 特徵 + LightGBM | 0.52588 | 0.5122 |
| C: 交互特徵 | 70 特徵 + LightGBM | 0.53120 | 0.4974 |
| D: 模型融合 | B+C 加權融合 (0.7:0.3) | 0.52592 | 0.5125 |
| E: 超參數調優 | C + Optuna 100 trials | **0.53809** | 0.5002 |
| F: SMOTE | C + SMOTE 過採樣 | 待測試 | 0.4859 |

### 4.3 方法E 最佳超參數
```python
{
    'n_estimators': 401,
    'max_depth': 8,
    'learning_rate': 0.0424,
    'num_leaves': 61,
    'min_child_samples': 42,
    'subsample': 0.729,
    'colsample_bytree': 0.945,
    'reg_alpha': 0.035,
    'reg_lambda': 0.0002
}
```

---

## 五、遇到的問題與解決方案

### 5.1 技術問題

| 問題 | 錯誤訊息 | 解決方案 |
|------|----------|----------|
| XGBoost 標籤錯誤 | `Expected [0 1 2 3], got [1 2 3 4]` | `y_train = y_train - 1` 轉為 0-based |
| Submission 格式錯誤 | 欄位名稱不符 | 'Index' → 'Id' |
| 檔案編碼問題 | Excel 開啟時亂碼 | 使用 `encoding='latin-1'` |

### 5.2 模型優化發現

1. **本地分數 vs Kaggle 分數不一致**
   - 方法C 本地 F1 (0.4974) < 方法B (0.5122)
   - 但 Kaggle: 方法C (0.53120) > 方法B (0.52588)
   - **結論**: 本地驗證集分布可能與測試集不同

2. **模型融合效果不佳**
   - 融合 (0.52592) ≈ 方法B (0.52588)
   - 原因：最佳權重 B:0.7 稀釋了方法C的貢獻

3. **SMOTE 效果待驗證**
   - 本地 F1 下降 (-2.3%)
   - 但 Kaggle 可能有不同結果

---

## 六、類別分布分析

### 6.1 原始分布 (不平衡)
| ASA | 數量 | 比例 |
|-----|------|------|
| 1 | 801 | 5.4% |
| 2 | 5,044 | 34.2% |
| 3 | 7,540 | 51.2% |
| 4 | 1,349 | 9.2% |

- ASA 3 : ASA 1 = 9.4 : 1 (嚴重不平衡)

### 6.2 處理策略
1. **class_weight='balanced'**: 在損失函數中加權
2. **SMOTE**: 過採樣少數類別

---

## 七、關鍵學習與反思

### 7.1 成功策略
1. ✅ 系統性的資料清洗流程
2. ✅ 文獻導向的特徵工程（BMI 分類、慢性病標記）
3. ✅ 交互特徵捕捉非線性關係
4. ✅ 超參數調優提升泛化能力

### 7.2 待改進之處
1. ⚠️ 本地驗證與 Kaggle 分數差異大，可考慮更好的交叉驗證策略
2. ⚠️ 模型融合策略可再優化（Stacking、Blending）
3. ⚠️ 文字特徵（Lab_Values, Medication_Usage）可能還有更多資訊可提取

### 7.3 改善幅度總結
- **整體提升**: +15.7% (0.46513 → 0.53809)
- **特徵工程貢獻**: +13.1% (A → B)
- **交互特徵貢獻**: +1.0% (B → C)
- **超參數調優貢獻**: +1.3% (C → E)

---

## 八、檔案結構

```
ASA 麻醉風險分級預測/
├── 資料清洗/
│   ├── train_cleaned.csv
│   ├── test_cleaned.csv
│   └── *.py (清洗腳本)
├── 方法A_Baseline/
│   ├── baseline_model.py
│   └── submission_baseline.csv (0.46513)
├── 方法B_完整特徵/
│   ├── feature_engineering.py
│   ├── advanced_model.py
│   ├── train_features.csv
│   └── submission_advanced.csv (0.52588)
├── 方法C_交互特徵/
│   ├── interaction_features.py
│   └── submission_interaction.csv (0.53120)
├── 方法D_模型融合/
│   ├── ensemble_model.py
│   └── submission_ensemble.csv (0.52592)
├── 方法E_超參數調優/
│   ├── tuning_model.py
│   └── submission_tuned.csv (0.53809) ⭐ 最佳
├── 方法F_SMOTE/
│   ├── improved_model_with_smote.py
│   └── submission_smote.csv (待測試)
└── 專案紀錄/
    └── 改善歷程總結.md (本文件)
```

---

## 九、後續建議

1. **進一步特徵工程**
   - NLP 處理 Lab_Values 文字
   - 提取更多藥物交互作用特徵

2. **模型優化**
   - 嘗試 CatBoost（原生支援類別特徵）
   - 神經網路（TabNet, SAINT）

3. **融合策略**
   - Stacking：用第一層模型的預測作為第二層特徵
   - 更細緻的權重搜索

4. **驗證策略**
   - 使用與 Kaggle 更接近的分層抽樣
   - 增加 Cross-validation folds

---

*文件建立日期: 2026-01-19*
*最後更新: 方法 E 達到最佳成績 0.53809*
